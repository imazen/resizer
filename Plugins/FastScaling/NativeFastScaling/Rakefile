require 'rake/loaders/makefile'
require 'rbconfig'
Rake.application.add_loader('d', Rake::MakefileLoader.new)

CLEAN = Rake::FileList["**/*~", "**/*.bak", "**/core"]
CLEAN.clear_exclude.exclude { |fn|
  fn.pathmap("%f").downcase == 'core' && File.directory?(fn)
}

CLEAN.include('*.o')

if /darwin|mac os/ =~ RbConfig::CONFIG['host_os']
  CXX = "g++-4.9"
  CC = "gcc-4.9"
else
  CXX = "g++"
  CC = "gcc"
end



desc "Remove any temporary products."
task :clean do
  CLEAN.each do |fn|
    rm_rf fn
    if Rake::Task.task_defined?(fn)
      task = Rake::Task[fn]
      task.reenable
    end
  end
end

CLOBBER = Rake::FileList.new

desc "Remove any generated file."
task :clobber => [:clean] do
  CLOBBER.each { |fn| rm_r fn rescue nil }
end


class String
  def to_task
    Rake::Task[self]
  end
end

task "malloc.h" do end
  
task :default => "fastscaling"

CFLAGS=%Q{-Wall -Wpedantic -Wno-unused-function -Wno-unused-but-set-variable -Wno-return-type -Werror -fPIC -std=gnu++11}

CLEAN.include('*.o')
CLEAN.include('*.d')
CLEAN.include('*.mf')
%w{ fastscaling libfastscaling.so }.each { |file| CLOBBER.include(file) if File.exists?(file) }

rule '.o' => '.cpp' do |t|
  sh "#{CXX}  #{CFLAGS} -MMD -c -o #{t.name} #{t.source}"
end

rule '.o' => '.c' do |t|
  sh "#{CC}  #{CFLAGS} -MMD -c -o #{t.name} #{t.source}"
end


rule '.d' => '.cpp' do |t|
  verbose(false) do 
    sh "#{CXX}  -MM -MG -MF #{t.name} #{t.source}"
  end
end

rule '.d' => '.c' do |t|
  verbose(false) do 
    sh "#{CC}  -MM -MG -MF #{t.name} #{t.source}"
  end
end


OBJECTS=%w{ fastscaling.o }

TEST_PROGRAM = "test_program"


desc "build a fastscaling program"
file "fastscaling" => OBJECTS do |t|
  sh "#{CXX} -Werror #{t.prerequisites.join(" ")}  -o #{t.name}"
end


desc "build the fastscaling library"
file "libfastscaling.so" => %w{ libfastscaling.o } do |t|
  sh "#{CXX}  --shared -o #{t.name} #{t.prerequisites.join(' ')}"
end

desc "run with valgrind"
task :valgrind => TEST_PROGRAM do
  sh "valgrind --leak-check=full --show-leak-kinds=all ./#{TEST_PROGRAM}"
end

desc "build the test program"
file TEST_PROGRAM => "test.o" do |t|
  sh "#{CXX} -Werror #{t.prerequisites.join(" ")}  -o #{t.name}"
end

task :test => "test_program" do
  sh "./#{TEST_PROGRAM}"
end

desc "runs each test case sequentially in a separate process"
task :test_each_case_in_separate_process => "test_program" do
  test_name_lines = `./#{TEST_PROGRAM} --list-test-names-only`
  test_names = test_name_lines.split("\n")
  test_names.each do |test_name|
    sh "./#{TEST_PROGRAM} '#{test_name}'"
  end
end

FileList['*.cpp'].each do |source_file|
  dependency_file = source_file.pathmap("%X.d")
  dependency_file.to_task
  import dependency_file
end

